<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>商談カレンダー（週）</title>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <style>
        body {
            background: #f5f7fa;
            font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", sans-serif;
        }

        /* 土日背景 */
        .fc-day-sun {
            background: rgba(244, 67, 54, 0.06);
        }

        .fc-day-sat {
            background: rgba(33, 150, 243, 0.06);
        }

        /* 週ビュー：時間枠の高さ */
        .fc-timegrid-slot {
            height: 48px !important;
        }

        /* 件数イベントスタイル */
        .summary-event {
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            line-height: 1.3;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div id="calendar"></div>

    <script>
        // ==========================
        // サーバーから取得したイベント
        // ==========================
        const RAW_EVENTS = {{ events | tojson | safe }};

        // 件数に応じたグラデーション色
        function getColorByCount(count) {
            const maxCount = 10;
            const ratio = Math.min(count / maxCount, 1);
            let r, g, b;

            if (ratio < 0.3) {
                r = Math.round(144 + (173 - 144) * (ratio / 0.3));
                g = Math.round(202 + (255 - 202) * (ratio / 0.3));
                b = Math.round(249 + (47 - 249) * (ratio / 0.3));
            } else if (ratio < 0.7) {
                const rRatio = (ratio - 0.3) / 0.4;
                r = Math.round(173 + (255 - 173) * rRatio);
                g = Math.round(255 - (255 - 152) * rRatio);
                b = Math.round(47 - (47 - 0) * rRatio);
            } else {
                const rRatio = (ratio - 0.7) / 0.3;
                r = 255;
                g = Math.round(152 - (152 * rRatio));
                b = 0;
            }

            return rgb(${r},${g},${b});
        }

        // 背景色に応じて文字色を白/黒に自動調整
        function getTextColor(bgColor) {
            const rgb = bgColor.match(/\d+/g).map(Number);
            const brightness = (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
            return brightness > 140 ? '#000' : '#fff';
        }

        // ==========================
        // 30分単位で件数集計イベント生成 (+9時間補正)
        // ==========================
        function generateSummaryEvents() {
            const summaryMap = {};

            RAW_EVENTS.forEach(ev => {
                let dt = new Date(ev.start);
                dt.setHours(dt.getHours() + 9); // 強制 +9時間

                const dateStr = dt.toISOString().split("T")[0];
                const hour = dt.getHours();
                const minute = dt.getMinutes() < 30 ? 0 : 30;
                const timeKey = ${String(hour).padStart(2, '0')}:${minute === 0 ? '00' : '30'};

                if (!summaryMap[dateStr]) summaryMap[dateStr] = {};
                if (!summaryMap[dateStr][timeKey]) summaryMap[dateStr][timeKey] = 0;

                summaryMap[dateStr][timeKey]++;
            });

            const summaryEvents = [];

            for (const date in summaryMap) {
                for (const time in summaryMap[date]) {
                    const count = summaryMap[date][time];
                    const [hour, minute] = time.split(":");

                    let endHour = parseInt(hour);
                    let endMinute = parseInt(minute) + 60;

                    if (endMinute === 60) {
                        endHour += 1;
                        endMinute = 0;
                    }

                    const start = ${date}T${hour}:${minute}:00;
                    const end = ${date}T${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}:00;
                    const bgColor = getColorByCount(count);

                    summaryEvents.push({
                        title: ${count}件,
                        start: start,
                        end: end,
                        display: 'block',
                        backgroundColor: bgColor,
                        borderColor: bgColor,
                        textColor: getTextColor(bgColor),
                        classNames: ['summary-event'],
                    });
                }
            }

            return summaryEvents;
        }

        // ==========================
        // カレンダー初期化
        // ==========================
        const calendar = new FullCalendar.Calendar(
            document.getElementById("calendar"),
            {
                locale: "ja",
                initialView: "timeGridWeek",
                height: "auto",

                customButtons: {
                    corporateform: {
                        text: "商談登録",
                        click: function () {
                            window.location.href = "https://giftsf.onrender.com/corporateform";
                        }
                    },
                    backmenu: {
                        text: "メニューに戻る",
                        click: function () {
                            window.location.href = "https://giftsf.onrender.com/menu_page";
                        }
                    }
                },

                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "backmenu,corporateform"
                },

                buttonText: {
                    today: "今日",
                    week: "週"
                },

                nowIndicator: true,
                allDaySlot: false,
                slotMinTime: "08:00:00",
                slotMaxTime: "20:00:00",
                events: generateSummaryEvents()
            }
        );

        calendar.render();
    </script>
</body>
</html>
