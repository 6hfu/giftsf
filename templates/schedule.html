<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    background: #f5f7fa;
    font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
}

/* ===== 土日背景（月表示含む） ===== */
.fc-day-sun { background: rgba(244, 67, 54, 0.08); }
.fc-day-sat { background: rgba(33, 150, 243, 0.08); }

/* ===== 月ビューのステータスラベル ===== */
.summary-wrap {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100px;
    margin-top: 6px;
    gap: 6px;
}

.summary {
    font-size: 13px;
    padding: 6px 8px;
    border-radius: 6px;
    color: #fff;
    min-height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    font-weight: 600;
    box-sizing: border-box;
}

/* ===== 週・日ビューのガントバー風イベント ===== */
.gantt-bar-event {
    background-color: #2196F3 !important;
    border-radius: 4px !important;
    height: 14px !important;  /* 小さくして縦に複数並べられる */
    margin-top: 2px;
    opacity: 0.8;
}
</style>
</head>
<body>

<div id="calendar"></div>

<script>
// ===== サーバーからのイベント =====
const RAW_EVENTS_ORIG = {{ events | tojson }};

// ===== 時刻補正（-6時間） =====
const RAW_EVENTS = RAW_EVENTS_ORIG.map(e => {
    const dt = new Date(e.start);
    dt.setHours(dt.getHours() - 6);
    return { ...e, start: dt };
});

// util
const getDateStr = d => d.toISOString().split("T")[0];
const getHour = d => d.getHours();

// ===== 月ビューのステータス表示 =====
function renderMonthSummary(info){
    if(info.view.type !== "dayGridMonth") return;

    const dateStr = getDateStr(info.date);
    const dayEvents = RAW_EVENTS.filter(e => getDateStr(e.start) === dateStr);

    const countMap = {};
    ["商談待ち","返答待ち","リスケ","留守"].forEach(s=>countMap[s]=0);
    dayEvents.forEach(e=>countMap[e.status]!==undefined && countMap[e.status]++);

    const wrap = document.createElement("div");
    wrap.className = "summary-wrap";

    const STATUS_COLORS = {
        "商談待ち": "#2196F3",
        "返答待ち": "#03A9F4",
        "リスケ": "#FF9800",
        "留守": "#FFC107"
    };

    ["商談待ち","返答待ち","リスケ","留守"].forEach(status=>{
        const div = document.createElement("div");
        div.className = "summary";
        if(countMap[status] > 0){
            div.textContent = `${status} ${countMap[status]}件`;
            div.style.backgroundColor = STATUS_COLORS[status];
        }
        wrap.appendChild(div);
    });

    info.el.querySelector(".fc-daygrid-day-frame")?.appendChild(wrap);
}

// ===== 週・日ビュー用：ガントバーイベント生成 =====
function generateGanttEvents(){
    const eventsMap = {};
    RAW_EVENTS.forEach(e=>{
        const key = getDateStr(e.start) + "_" + getHour(e.start);
        if(!eventsMap[key]) eventsMap[key]=[];
        eventsMap[key].push(e);
    });

    const fcEvents = [];
    const maxBarsPerHour = 5;

    for(const key in eventsMap){
        const [dateStr,hourStr] = key.split("_");
        const hour = parseInt(hourStr);
        const eventsInHour = eventsMap[key].slice(0, maxBarsPerHour); // 最大5件

        eventsInHour.forEach((e,i)=>{
            const start = new Date(dateStr + "T" + String(hour).padStart(2,"0") + ":00:00");
            const end = new Date(start.getTime() + 30*60*1000); // 30分幅
            fcEvents.push({
                start: start,
                end: end,
                allDay: false,
                display: 'block',
                className: 'gantt-bar-event'
            });
        });
    }
    return fcEvents;
}

const FC_EVENTS = generateGanttEvents();

// ===== カレンダー初期化 =====
const calendar = new FullCalendar.Calendar(
    document.getElementById("calendar"),{
        locale: "ja",
        initialView: "dayGridMonth",
        height: "auto",

        headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay"
        },

        buttonText: {
            today: "今日",
            month: "月",
            week: "週",
            day: "日"
        },

        nowIndicator: true,
        slotMinTime: "08:00:00",
        slotMaxTime: "20:00:00",
        allDaySlot: false,

        dayCellDidMount: renderMonthSummary,

        events: FC_EVENTS,  // 週・日ビューでバー表示

        dateClick: info => calendar.changeView("timeGridDay", info.dateStr),

        slotLabelContent: info => info.text
    }
);

calendar.render();
</script>

</body>
</html>
