<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>商談スケジュール</title>

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* 全体背景とカレンダー余白 */
        body { background-color: #f8f9fa; font-family: "Noto Sans JP", sans-serif; }
        #calendar { background: white; border-radius: 12px; padding: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        /* 月表示用バッジ */
        .status-badge { display: inline-block; border-radius: 12px; padding: 2px 6px; font-size: 0.75rem; color: white; margin: 1px 1px; }

        /* 週・日表示のイベントカスタム */
        .fc-event-title { font-weight: 600; font-size: 0.85rem; }
        .fc-event-status { font-size: 0.75rem; padding-left: 3px; }

        /* 月の曜日表示 */
        .fc-col-header-cell-cushion { font-weight: 700; font-size: 0.95rem; color: #333; }
        .fc-daygrid-day-number { font-weight: 600; }

        /* 週・日表示の重複イベントカラー順 */
        .dup-1 { background-color: #2196F3 !important; } /* 青 */
        .dup-2 { background-color: #FFC107 !important; } /* 黄 */
        .dup-3 { background-color: #F44336 !important; } /* 赤 */
    </style>
</head>
<body>

<div class="container mt-4">
    <h3 class="mb-3 text-center">商談スケジュール</h3>
    <div id="calendar"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const events = {{ events | tojson }};
    
    // 月表示用集計データ作成
    const monthCounts = {};
    events.forEach(e => {
        const day = e.start.split('T')[0];
        if (!monthCounts[day]) monthCounts[day] = {};
        if (!monthCounts[day][e.status]) monthCounts[day][e.status] = 0;
        monthCounts[day][e.status]++;
    });

    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ja',
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        dayCellDidMount: function(info) {
            if (calendar.view.type !== 'dayGridMonth') return;

            const dateStr = info.date.toISOString().split('T')[0];
            if (!monthCounts[dateStr]) return;

            const container = document.createElement('div');
            for (const [status, count] of Object.entries(monthCounts[dateStr])) {
                const badge = document.createElement('span');
                badge.className = 'status-badge';
                badge.style.backgroundColor = status_color(status);
                badge.textContent = `${status} ${count}`;
                container.appendChild(badge);
            }
            info.el.appendChild(container);
        },
        eventContent: function(arg) {
            // 重複順にカラー設定
            let colorClass = '';
            if (arg.event.extendedProps.dupIndex === 1) colorClass = 'dup-1';
            if (arg.event.extendedProps.dupIndex === 2) colorClass = 'dup-2';
            if (arg.event.extendedProps.dupIndex === 3) colorClass = 'dup-3';

            const inner = document.createElement('div');
            inner.innerHTML = `<span class="fc-event-title">${arg.event.title}</span>
                               <span class="fc-event-status">${arg.event.extendedProps.status}</span>`;
            if (arg.event.extendedProps.dupCount && arg.event.extendedProps.dupCount > 3) {
                inner.innerHTML += `<span class="fc-event-status"> +${arg.event.extendedProps.dupCount-3}件</span>`;
            }
            return { domNodes: [inner] };
        },
        events: events.map(e => {
            // 同じ時間帯の重複計算
            const sameTime = events.filter(ev => ev.start === e.start);
            const dupIndex = sameTime.findIndex(ev => ev.id === e.id) + 1;
            return { ...e, extendedProps: { status: e.status, dupIndex, dupCount: sameTime.length } };
        }),
        eventDisplay: 'block',
        nowIndicator: true,
        dayMaxEvents: true,  // 3件以上は「+N件」表示
        slotMinTime: "08:00:00",
        slotMaxTime: "20:00:00"
    });

    calendar.render();

    // ステータスカラー関数
    function status_color(status) {
        return {
            "成約": "#4CAF50",
            "NG": "#9E9E9E",
            "留守": "#FFC107",
            "リスケ": "#FF9800",
            "返答待ち": "#03A9F4",
            "商談待ち": "#2196F3",
        }[status] || "#BDBDBD";
    }
});
</script>

</body>
</html>
