<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    background: #f5f7fa;
    font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
}

/* ===== 土日背景 ===== */
.fc-day-sun {
    background: rgba(244, 67, 54, 0.08);
}
.fc-day-sat {
    background: rgba(33, 150, 243, 0.08);
}

/* ===== 月ビュー（変更なし） ===== */
.summary-wrap {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100px;
    margin-top: 6px;
    gap: 6px;
}
.summary {
    font-size: 13px;
    padding: 6px 8px;
    border-radius: 6px;
    color: #fff;
    min-height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    font-weight: 600;
}

/* ===== 週・日ビュー ===== */
.slot-wrap {
    display: flex;
    gap: 4px;
    margin-top: 4px;
}
.slot-block {
    min-width: 26px;
    height: 18px;
    border-radius: 4px;
    background: #90caf9;
}
.slot-more {
    font-size: 11px;
    font-weight: 600;
    color: #555;
    margin-left: 4px;
}
</style>
</head>
<body>

<div id="calendar"></div>

<script>
// ===== Salesforceイベント =====
const RAW_EVENTS_ORIG = {{ events | tojson }};

// ===== 対象ステータス =====
const TARGET_STATUSES = ["商談待ち","返答待ち","リスケ","留守"];

// ===== 6時間補正 =====
const RAW_EVENTS = RAW_EVENTS_ORIG.map(e => {
    const d = new Date(e.start);
    d.setHours(d.getHours() - 6);
    return { ...e, start: d };
});

// util
const dateStr = d => d.toISOString().split("T")[0];

// ===== 月ビュー（そのまま） =====
function renderMonthSummary(info){
    if(info.view.type !== "dayGridMonth") return;

    const day = dateStr(info.date);
    const counts = {"商談待ち":0,"返答待ち":0,"リスケ":0,"留守":0};

    RAW_EVENTS.forEach(e => {
        if(dateStr(e.start) === day && counts[e.status] !== undefined){
            counts[e.status]++;
        }
    });

    const wrap = document.createElement("div");
    wrap.className = "summary-wrap";

    Object.keys(counts).forEach(s => {
        const div = document.createElement("div");
        div.className = "summary";
        if(counts[s] > 0){
            div.textContent = `${s} ${counts[s]}件`;
            div.style.background = "#607d8b";
        }
        wrap.appendChild(div);
    });

    info.el.querySelector(".fc-daygrid-day-frame")?.appendChild(wrap);
}

// ===== 週・日ビュー（ここが修正ポイント） =====
function renderDayWeekSlots(info){
    if(!info.date) return;

    const slotStart = info.date;
    const slotEnd = new Date(slotStart);
    slotEnd.setMinutes(slotEnd.getMinutes() + 30);

    const events = RAW_EVENTS.filter(e =>
        TARGET_STATUSES.includes(e.status) &&
        e.start >= slotStart &&
        e.start < slotEnd
    );

    if(events.length === 0) return;

    const wrap = document.createElement("div");
    wrap.className = "slot-wrap";

    const show = events.slice(0,5);
    show.forEach(() => {
        const block = document.createElement("div");
        block.className = "slot-block";
        wrap.appendChild(block);
    });

    if(events.length > 5){
        const more = document.createElement("span");
        more.className = "slot-more";
        more.textContent = `+${events.length - 5}件`;
        wrap.appendChild(more);
    }

    info.el.appendChild(wrap);
}

// ===== カレンダー =====
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"),{
    locale: "ja",
    initialView: "dayGridMonth",
    height: "auto",

    headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
    },
    buttonText: {
        today: "今日",
        month: "月",
        week: "週",
        day: "日"
    },

    nowIndicator: true,
    slotMinTime: "08:00:00",
    slotMaxTime: "20:00:00",
    slotDuration: "00:30:00",
    allDaySlot: false,

    dayCellDidMount: renderMonthSummary,
    slotLaneDidMount: renderDayWeekSlots
});

calendar.render();
</script>

</body>
</html>
