<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>商談スケジュール</title>

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        #calendar {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 10px;
        }

        .fc-event {
            color: #fff;
            font-weight: 600;
            border-radius: 6px;
            padding: 2px 4px;
            font-size: 0.85rem;
        }

        .fc-more-link {
            color: #555 !important;
            font-weight: bold;
            font-size: 0.85rem;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <h3 class="mb-3 text-center">商談スケジュール</h3>
    <div id="calendar"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const overlappingColors = ["#2196F3", "#FFC107", "#F44336"]; // 青、黄、赤

    // イベントデータ
    const rawEvents = {{ events | tojson }};

    // 同じ時間のイベント件数を計算
    const eventsByTime = {};
    rawEvents.forEach(e => {
        const key = e.start;
        if (!eventsByTime[key]) eventsByTime[key] = [];
        eventsByTime[key].push(e);
    });

    // 色分けと「＋件」の処理
    const processedEvents = [];
    Object.values(eventsByTime).forEach(eventGroup => {
        eventGroup.forEach((e, idx) => {
            if (idx < 2) { // 1件目と2件目は通常表示
                e.backgroundColor = overlappingColors[idx];
                e.borderColor = overlappingColors[idx];
                e.textColor = "#fff";
                processedEvents.push(e);
            } else if (idx === 2) { // 3件目以降はまとめて「＋N件」
                const extraCount = eventGroup.length - 2;
                processedEvents.push({
                    title: `＋${extraCount}件`,
                    start: e.start,
                    allDay: false,
                    backgroundColor: "#9E9E9E",
                    borderColor: "#9E9E9E",
                    textColor: "#fff",
                    extendedProps: { isExtra: true }
                });
            }
        });
    });

    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ja',
        initialView: 'dayGridMonth',
        height: 'auto',

        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        events: processedEvents,
        eventDisplay: 'block',
        eventContent: function(arg) {
            if (arg.event.extendedProps.isExtra) {
                return { html: `<div>${arg.event.title}</div>` };
            }
            return {
                html: `<div>${arg.event.title}<br><small>${arg.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small></div>`
            };
        },

        dateClick: function(info) {
            // 日付クリックでDAY表示に切り替え
            calendar.changeView('timeGridDay', info.dateStr);
        }
    });

    calendar.render();
});
</script>

</body>
</html>
