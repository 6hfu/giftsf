<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const events = {{ events|tojson }};

    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ja',
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,resourceTimeGridDay'
        },
        events: events,

        eventContent: function(arg){
            const statusColors = {
                "成約": "#4CAF50",
                "NG": "#9E9E9E",
                "留守": "#FFC107",
                "リスケ": "#FF9800",
                "返答待ち": "#03A9F4",
                "商談待ち": "#2196F3"
            };

            // 月ビュー
            if(arg.view.type === 'dayGridMonth'){
                const dateStr = arg.event.startStr.split('T')[0];
                const dayEvents = calendar.getEvents().filter(ev => ev.startStr.split('T')[0] === dateStr);

                if(arg.event._rendered) return { html: '' };
                dayEvents.forEach(ev => ev._rendered = true);

                // ステータス別件数集計
                const counts = {};
                dayEvents.forEach(ev => {
                    const s = ev.extendedProps.status || '未定';
                    counts[s] = (counts[s] || 0) + 1;
                });

                let html = '<ul class="status-list">';
                for(let s in counts){
                    html += `<li style="background-color:${statusColors[s]||'#BDBDBD'}">${s}: ${counts[s]}件</li>`;
                }
                html += '</ul>';
                return { html: html };
            }

            // 週ビュー
            else if(arg.view.type === 'timeGridWeek'){
                const startHour = arg.event.start.getHours();
                const endHour = arg.event.end ? arg.event.end.getHours() : startHour;
                const slotEvents = calendar.getEvents().filter(ev => {
                    const evHour = ev.start.getHours();
                    return ev.startStr.split('T')[0] === arg.event.startStr.split('T')[0] && evHour === startHour;
                });

                // ステータス別件数
                const counts = {};
                slotEvents.forEach(ev => {
                    const s = ev.extendedProps.status || '未定';
                    counts[s] = (counts[s] || 0) + 1;
                });

                let html = '';
                for(let s in counts){
                    let displayCount = counts[s];
                    if(displayCount > 3){
                        html += `<div style="background-color:${statusColors[s]}; padding:2px 4px; border-radius:6px; margin-bottom:1px;">${s}: 3件 +${displayCount-3}</div>`;
                    } else {
                        html += `<div style="background-color:${statusColors[s]}; padding:2px 4px; border-radius:6px; margin-bottom:1px;">${s}: ${displayCount}件</div>`;
                    }
                }
                return { html: html };
            }

            // 日ビュー
            else if(arg.view.type === 'resourceTimeGridDay'){
                const status = arg.event.extendedProps.status || '未定';
                const color = arg.event.color || statusColors[status] || '#BDBDBD';
                return { html: `<div style="background-color:${color}; padding:2px 4px; border-radius:6px;">${status}</div>` };
            }
        },

        // 日クリックで日ビューに遷移
        dateClick: function(info){
            calendar.changeView('resourceTimeGridDay', info.dateStr);
        },

        nowIndicator: true,
        dayMaxEventRows: true,
        slotMinTime: "08:00:00",
        slotMaxTime: "20:00:00"
    });

    calendar.render();
});
</script>
