<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談負荷カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    font-family: system-ui, -apple-system;
    background: #f4f6f8;
}

#calendar {
    background: #fff;
    border-radius: 12px;
    padding: 10px;
}

/* 共通ブロック */
.summary {
    font-size: 11px;
    padding: 4px;
    border-radius: 6px;
    color: #fff;
    margin-bottom: 3px;
}

/* 危険度カラー */
.safe { background: #4CAF50; }
.warn { background: #FFC107; color:#000; }
.danger { background: #F44336; }

.hour-box {
    padding: 4px;
    border-radius: 6px;
    font-size: 12px;
}
</style>
</head>

<body>
<div id="calendar"></div>

<script>
const EVENTS = {{ events | tojson }};

function dangerClass(count) {
    if (count >= 4) return "danger";
    if (count >= 2) return "warn";
    return "safe";
}

function groupBy(arr, keyFn) {
    return arr.reduce((acc, x) => {
        const k = keyFn(x);
        acc[k] = acc[k] || [];
        acc[k].push(x);
        return acc;
    }, {});
}

const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    locale: "ja",
    initialView: "dayGridMonth",
    headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
    },
    events: EVENTS,

    /* ===== MONTH & WEEK（日単位） ===== */
    dayCellDidMount(info) {
        if (!["dayGridMonth", "timeGridWeek"].includes(calendar.view.type)) return;

        const dateStr = info.date.toISOString().split("T")[0];
        const dayEvents = EVENTS.filter(e => e.start.startsWith(dateStr));
        if (dayEvents.length === 0) return;

        const grouped = groupBy(dayEvents, e => e.status);
        const wrap = document.createElement("div");

        Object.keys(grouped).forEach(status => {
            const count = grouped[status].length;
            const div = document.createElement("div");
            div.className = `summary ${dangerClass(count)}`;
            div.textContent = `${status} ${count}件`;
            wrap.appendChild(div);
        });

        info.el.querySelector(".fc-daygrid-day-events")?.appendChild(wrap);
    },

    /* ===== DAY（時間単位） ===== */
    slotLabelDidMount(info) {
        if (calendar.view.type !== "timeGridDay") return;

        const hour = info.date.getHours();
        const dateStr = calendar.getDate().toISOString().split("T")[0];

        const hourEvents = EVENTS.filter(e => {
            const d = new Date(e.start);
            return d.toISOString().startsWith(dateStr) && d.getHours() === hour;
        });

        if (hourEvents.length === 0) return;

        const grouped = groupBy(hourEvents, e => e.status);

        const box = document.createElement("div");
        box.className = `hour-box ${dangerClass(hourEvents.length)}`;

        let text = "";
        Object.keys(grouped).forEach(s => {
            text += `${s}:${grouped[s].length} `;
        });
        box.textContent = text.trim();

        info.el.appendChild(box);
    },

    dateClick(info) {
        calendar.changeView("timeGridDay", info.dateStr);
    },

    slotMinTime: "08:00:00",
    slotMaxTime: "20:00:00",
    nowIndicator: true
});

calendar.render();
</script>
</body>
</html>
