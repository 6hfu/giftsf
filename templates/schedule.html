<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー（週・日）</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    background: #f5f7fa;
    font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
    padding-top: 60px;
}

/* ===== 土日背景 ===== */
.fc-day-sun { background: rgba(244, 67, 54, 0.06); }
.fc-day-sat { background: rgba(33, 150, 243, 0.06); }

/* ===== 件数ラベル ===== */
.summary-wrap {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.summary {
    font-size: 12px;
    padding: 4px 6px;
    border-radius: 6px;
    color: #fff;
    font-weight: 600;
    text-align: center;
    line-height: 1.2;
}

/* ===== 週・日ビュー：時間枠を広げる ===== */
.fc-timegrid-slot {
    height: 48px !important;
}

/* ===== Corporateform ボタン ===== */
.fc-corporateform-button {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: #fff !important;
    font-size: 15px;
    font-weight: 700;
    padding: 10px 18px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    border: none;
}
.fc-corporateform-button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}
</style>
</head>

<body>
<div id="calendar"></div>

<script>
// ==========================
// サーバーから取得したイベント
// ==========================
const RAW_EVENTS_ORIG = {{ events | tojson | safe }};

// ===== 時刻補正（-6時間）=====
const RAW_EVENTS = RAW_EVENTS_ORIG.map(e => {
    const d = new Date(e.start);
    d.setHours(d.getHours() - 6);
    return { ...e, start: d };
});

// util
const getDateStr = d => d.toISOString().split("T")[0];
const getHourStr = d => d.getHours();  // 時間帯を取得

// ステータス色
const STATUS_COLORS = {
    "商談待ち": "#2196F3",
    "返答待ち": "#03A9F4",
    "リスケ": "#FF9800",
    "留守": "#FFC107"
};
const STATUSES = Object.keys(STATUS_COLORS);

// ==========================
// 時間帯ごとの件数HTML生成
// ==========================
function buildTimeSlotSummary(date, hour) {
    const dayEvents = RAW_EVENTS.filter(e => {
        const d = new Date(e.start);
        return getDateStr(d) === getDateStr(date) && d.getHours() === hour;
    });
    if (dayEvents.length === 0) return null;

    const countMap = {};
    STATUSES.forEach(s => countMap[s] = 0);
    dayEvents.forEach(e => {
        if (countMap[e.status] !== undefined) countMap[e.status]++;
    });

    const wrap = document.createElement("div");
    wrap.className = "summary-wrap";

    STATUSES.forEach(status => {
        if (countMap[status] === 0) return;
        const div = document.createElement("div");
        div.className = "summary";
        div.style.background = STATUS_COLORS[status];
        div.textContent = `${status} ${countMap[status]}件`;
        wrap.appendChild(div);
    });

    return wrap;
}

// ==========================
// 時間枠に件数表示
// ==========================
function renderTimeGrid(info) {
    const hour = info.slotStart.getHours();
    const summary = buildTimeSlotSummary(info.date, hour);
    if (!summary) return;

    info.el.appendChild(summary);
}

// ==========================
// カレンダー初期化
// ==========================
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    locale: "ja",
    initialView: "timeGridWeek",  // 週ビュー
    height: "auto",

    customButtons: {
        corporateform: {
            text: "商談登録",
            click: function () {
                window.location.href = "https://giftsf.onrender.com/corporateform";
            }
        }
    },

    headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "corporateform timeGridWeek,timeGridDay"
    },

    buttonText: {
        today: "今日",
        week: "週",
        day: "日"
    },

    nowIndicator: true,
    allDaySlot: false,
    slotMinTime: "08:00:00",
    slotMaxTime: "20:00:00",

    slotLabelDidMount: renderTimeGrid,  // 時間帯に件数表示
});

calendar.render();
</script>
</body>
</html>
