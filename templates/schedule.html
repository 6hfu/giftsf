<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー（週）</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    background: #f5f7fa;
    font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", sans-serif;
    margin: 0;
}

/* 土日背景 */
.fc-day-sun { background: rgba(244, 67, 54, 0.06); }
.fc-day-sat { background: rgba(33, 150, 243, 0.06); }

/* 時間枠高さ */
.fc-timegrid-slot { height: 34px !important; }

/* 商談チップ */
.meeting-event {
    border-radius: 8px;
    padding: 4px 6px;
    font-size: 13px;
    line-height: 1.3;
    white-space: normal;
    overflow: hidden;
}

/* ⭐ チップ横幅を少し細くする（左寄せ） */
.fc-timegrid-event {
    width: 85% !important;   /* 好きな割合に変更OK 85〜92%くらいが見やすい */
    margin-left: 0 !important;
    margin-right: auto !important;
}


.meeting-scroll { display: flex; flex-direction: column; height: 100%; }

.meeting-header {
    position: sticky;
    top: 0;
    background: inherit;
    z-index: 2;
    padding-bottom: 4px;
}

.meeting-body {
    overflow-y: auto;
    flex: 1;
    padding-right: 2px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}
.meeting-body::-webkit-scrollbar { width: 0; }

.meeting-event:hover .meeting-body { scrollbar-width: thin; }
.meeting-event:hover .meeting-body::-webkit-scrollbar { width: 6px; }
.meeting-event:hover .meeting-body::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.3);
    border-radius: 4px;
}

.meeting-footer {
    position: sticky;
    bottom: 0;
    background: inherit;
    padding-top: 4px;
    font-size: 12px;
    font-weight: 600;
}

#reloadNotice {
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: #1976D2;
    color: #fff;
    padding: 12px 20px;
    border-radius: 999px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    cursor: pointer;
    display: none;
    z-index: 9999;
}
</style>
</head>

<body>

<div id="calendar"></div>
<div id="reloadNotice">⟳ しばらく更新されていません。クリックして再読み込み</div>

<script>

const RAW_EVENTS = {{ events | tojson | safe }};
let clickTimer = null;


// ==========================
// 同時刻まとめ + 色分け
// ==========================
function convertMeetingEvents() {

    const expanded = RAW_EVENTS.map(ev => {
        if (!ev.start) return null;

        const start = new Date(ev.start);
        start.setHours(start.getHours() + 9);

        const end = new Date(start);
        end.setHours(end.getHours() + 2);

        return { ...ev, start, end };
    }).filter(Boolean);

    const groups = {};

    expanded.forEach(ev => {
        const key =
            ev.start.getFullYear() + "-" +
            ev.start.getMonth() + "-" +
            ev.start.getDate() + "-" +
            ev.start.getHours() + ":" +
            ev.start.getMinutes();

        if (!groups[key]) groups[key] = [];
        groups[key].push(ev);
    });

    function getColor(count) {
        if (count >= 3) return "#ef5350";
        if (count === 2) return "#ffa726";
        return "#42a5f5";
    }

    const merged = [];

    Object.values(groups).forEach(list => {

        const base = list[0];
        const count = list.length;

        merged.push({
            start: base.start,
            end: base.end,
            title: "商談待ち",
            classNames: ['meeting-event'],
            backgroundColor: getColor(count),
            borderColor: getColor(count),
            textColor: "#000",
            extendedProps: { meetings: list }
        });

    });

    return merged;
}

// ==========================
// リロード管理
// ==========================
const RELOAD_LIMIT_MINUTES = 10;
const now = Date.now();
const lastReload = localStorage.getItem("lastReloadTime");

if (lastReload) {
    const diff = (now - Number(lastReload)) / 1000 / 60;
    if (diff >= RELOAD_LIMIT_MINUTES) {
        document.getElementById("reloadNotice").style.display = "block";
    }
}

document.getElementById("reloadNotice").onclick = () => location.reload();
localStorage.setItem("lastReloadTime", now);

// ==========================
// カレンダー
// ==========================
const calendar = new FullCalendar.Calendar(
document.getElementById("calendar"),
{
    locale: "ja",
    initialView: "timeGridWeek",
    height: "100vh",

    // ★追加：ダブルクリック登録
    dateClick: function(info) {

        if (clickTimer === null) {
            clickTimer = setTimeout(() => {
                clickTimer = null;
            }, 300);
            return;
        }

        clearTimeout(clickTimer);
        clickTimer = null;

        const d = new Date(info.date);

        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mi = String(d.getMinutes()).padStart(2, '0');

        const date = `${yyyy}-${mm}-${dd}`;
        const time = `${hh}:${mi}`;

        if (!confirm(`${date} ${time} で商談登録しますか？`)) return;

        location.href =
            "https://giftsf.onrender.com/corporateform"
            + `?date=${date}&time=${time}`;
    },




    customButtons: {
        reload: {
            text: "再読込",
            click: () => location.reload()
        },
        corporateform: {
            text: "商談登録",
            click: () =>
                location.href = "https://giftsf.onrender.com/corporateform"
        },
        backmenu: {
            text: "メニューに戻る",
            click: () =>
                location.href = "https://giftsf.onrender.com/menu_page"
        }
    },

    headerToolbar: {
        left: "prev,next today reload",
        center: "title",
        right: "backmenu corporateform"
    },

    nowIndicator: true,
    allDaySlot: false,
    slotMinTime: "09:00:00",
    slotMaxTime: "20:00:00",

    events: convertMeetingEvents(),

    eventContent: function(arg) {

        const meetings = arg.event.extendedProps.meetings || [];
        const timeText = arg.timeText || "";

        const wrapper = document.createElement("div");
        wrapper.classList.add("meeting-scroll");

        const header = document.createElement("div");
        header.classList.add("meeting-header");

        const count = meetings.length;
        header.innerHTML = `<b>${timeText} 商談待ち（${count}件）</b>`;

        const body = document.createElement("div");
        body.classList.add("meeting-body");

        let bodyHtml = "";

        meetings.slice(0, 3).forEach((m, index) => {
        
            const owner = m.extendedProps?.meeting_owner || "";
            const store = m.title || "";
            const status = m.extendedProps?.status || "";
        
            bodyHtml += `
                <div>
                    <div style="font-weight:600;">${store}</div>
                    <div style="font-size:12px;color:#333;">担当：${owner}</div>
                    <div style="font-size:12px;color:#1976D2;">ステータス：${status}</div>
                </div>
            `;

            }
        });

        body.innerHTML = bodyHtml;

        let footer = null;

        if (meetings.length > 3) {
            footer = document.createElement("div");
            footer.classList.add("meeting-footer");
            footer.textContent = `＋${meetings.length - 3}件`;
        }

        wrapper.appendChild(header);
        wrapper.appendChild(body);
        if (footer) wrapper.appendChild(footer);

        return { domNodes: [wrapper] };
    }

});

calendar.render();

</script>
</body>
</html>
