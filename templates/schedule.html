<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー（週）</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    margin: 0;
    background: #f5f7fa;
    font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
}

/* 土日背景 */
.fc-day-sun { background: rgba(244, 67, 54, 0.06); }
.fc-day-sat { background: rgba(33, 150, 243, 0.06); }

/* 時間枠の高さ（1画面最適化） */
.fc-timegrid-slot {
    height: 38px !important;
}

/* 件数イベント */
.summary-event {
    font-size: 17px;          /* 文字を大きく */
    font-weight: 700;
    text-align: center;
    line-height: 1.2;
    border-radius: 8px;
    padding: 2px 0;
}

/* ヘッダーを少しスリムに */
.fc-toolbar-title {
    font-size: 20px;
}
</style>
</head>

<body>
<div id="calendar"></div>

<script>
// ==========================
// サーバーから取得したイベント
// ==========================
const RAW_EVENTS = {{ events | tojson | safe }};

// ==========================
// 件数 → 色（濃い青スタート）
// ==========================
function getColorByCount(count) {
    const colors = [
        '#1976D2', // 1件: 濃い青
        '#1565C0', // 2件
        '#0D47A1', // 3件
        '#FBC02D', // 4件: 黄色
        '#FB8C00', // 5件: オレンジ
        '#F4511E', // 6件: 橙赤
        '#D32F2F', // 7件以上: 赤
    ];
    return colors[Math.min(count - 1, colors.length - 1)];
}

// 文字色自動判定
function getTextColor(bgColor) {
    const rgb = bgColor.match(/\d+/g).map(Number);
    const brightness = (rgb[0]*299 + rgb[1]*587 + rgb[2]*114) / 1000;
    return brightness > 150 ? '#000' : '#fff';
}

// ==========================
// 30分単位で件数集計（+9時間補正）
// ==========================
function generateSummaryEvents() {
    const summaryMap = {};

    RAW_EVENTS.forEach(ev => {
        let dt = new Date(ev.start);
        dt.setHours(dt.getHours() + 9);

        const dateStr = dt.toISOString().split("T")[0];
        const hour = dt.getHours();
        const minute = dt.getMinutes() < 30 ? 0 : 30;
        const timeKey = `${String(hour).padStart(2,'0')}:${minute===0?'00':'30'}`;

        summaryMap[dateStr] ??= {};
        summaryMap[dateStr][timeKey] ??= 0;
        summaryMap[dateStr][timeKey]++;
    });

    const events = [];
    for (const date in summaryMap) {
        for (const time in summaryMap[date]) {
            const count = summaryMap[date][time];
            const [h, m] = time.split(":").map(Number);

            let endH = h + 1;
            let endM = m;

            const bg = getColorByCount(count);

            events.push({
                title: `${count}件`,
                start: `${date}T${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`,
                end: `${date}T${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}:00`,
                backgroundColor: bg,
                borderColor: bg,
                textColor: getTextColor(bg),
                classNames: ['summary-event']
            });
        }
    }
    return events;
}

// ==========================
// カレンダー初期化
// ==========================
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    locale: "ja",
    initialView: "timeGridWeek",

    /* ★ 1画面フィットの核心 */
    height: "calc(100vh - 20px)",

    nowIndicator: true,
    allDaySlot: false,
    slotMinTime: "09:00:00",
    slotMaxTime: "20:00:00",

    customButtons: {
        corporateform: {
            text: "商談登録",
            click: () => location.href = "https://giftsf.onrender.com/corporateform"
        },
        backmenu: {
            text: "メニューに戻る",
            click: () => location.href = "https://giftsf.onrender.com/menu_page"
        }
    },

    headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "backmenu corporateform"
    },

    buttonText: {
        today: "今日"
    },

    events: generateSummaryEvents()
});

calendar.render();
</script>
</body>
</html>
