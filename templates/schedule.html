<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    background: #f5f7fa;
    font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
}

/* ===== 土日背景 ===== */
.fc-day-sun {
    background: rgba(244, 67, 54, 0.08);
}
.fc-day-sat {
    background: rgba(33, 150, 243, 0.08);
}

/* ===== 月ビュー（縦4枠・高さ固定） ===== */
.summary-wrap {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100px;              /* ← 高さアップ */
    margin-top: 6px;
    gap: 6px;                   /* ← 余白追加 */
}

.summary {
    font-size: 13px;
    padding: 6px 8px;
    border-radius: 6px;
    color: #fff;
    min-height: 22px;

    display: flex;               /* ★追加 */
    align-items: center;         /* ★縦中央 */
    justify-content: center;     /* ★横中央 */

    line-height: 1;              /* ★重要：余計な下ズレ防止 */
    font-weight: 600;
    box-sizing: border-box;
}


/* ===== 週・日ビュー ===== */
.slot-label {
    font-size: 12px;
    margin: 3px 0;
    padding: 4px 6px;
    border-radius: 6px;
    color: #fff;
    font-weight: 600;
}
</style>
</head>
<body>

<div id="calendar"></div>

<script>
// ===== サーバーからのイベント =====
const RAW_EVENTS_ORIG = {{ events | tojson }};

// ===== ステータス色 =====
const STATUS_COLORS = {
    "商談待ち": "#2196F3",
    "返答待ち": "#03A9F4",
    "リスケ": "#FF9800",
    "留守": "#FFC107"
};

// ===== 表示順（指定通り） =====
const SUMMARY_STATUSES = [
    "商談待ち",
    "返答待ち",
    "リスケ",
    "留守"
];

// ===== 時刻補正（-6時間） =====
const RAW_EVENTS = RAW_EVENTS_ORIG.map(e => {
    const dt = new Date(e.start);
    dt.setHours(dt.getHours() - 6);
    return { ...e, start: dt };
});

// util
const getDateStr = d => d.toISOString().split("T")[0];
const getHour = d => d.getHours();

// ===== 月ビュー描画 =====
function renderMonthSummary(info){
    if(info.view.type !== "dayGridMonth") return;

    const dateStr = getDateStr(info.date);
    const dayEvents = RAW_EVENTS.filter(e => getDateStr(e.start) === dateStr);

    const countMap = {};
    SUMMARY_STATUSES.forEach(s => countMap[s] = 0);
    dayEvents.forEach(e => countMap[e.status] !== undefined && countMap[e.status]++);

    const wrap = document.createElement("div");
    wrap.className = "summary-wrap";

    SUMMARY_STATUSES.forEach(status => {
        const div = document.createElement("div");
        div.className = "summary";

        if(countMap[status] > 0){
            div.textContent = `${status} ${countMap[status]}件`;
            div.style.backgroundColor = STATUS_COLORS[status];
        }

        wrap.appendChild(div);
    });

    info.el.querySelector(".fc-daygrid-day-frame")?.appendChild(wrap);
}

// ===== 週・日ビュー =====
function renderDayWeekSlots(info){
    const dateStr = getDateStr(info.date);
    const hour = getHour(info.date);

    const hourEvents = RAW_EVENTS.filter(
        e => getDateStr(e.start) === dateStr && getHour(e.start) === hour
    );

    if(hourEvents.length === 0) return;

    const wrap = document.createElement("div");

    hourEvents.slice(0,5).forEach(e => {
        const div = document.createElement("div");
        div.className = "slot-label";
        div.textContent = e.status;
        div.style.backgroundColor = STATUS_COLORS[e.status] || "#BDBDBD";
        wrap.appendChild(div);
    });

    info.el.appendChild(wrap);
}

// ===== カレンダー初期化 =====
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"),{
    locale: "ja",
    initialView: "dayGridMonth",
    height: "auto",

    headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
    },

    buttonText: {
        today: "今日",
        month: "月",
        week: "週",
        day: "日"
    },

    nowIndicator: true,
    slotMinTime: "08:00:00",
    slotMaxTime: "20:00:00",
    allDaySlot: false,

    dayCellDidMount: renderMonthSummary,
    slotLaneDidMount: renderDayWeekSlots,

    dateClick: info => calendar.changeView("timeGridDay", info.dateStr),

    slotLabelContent: info => {
        const count = RAW_EVENTS.filter(
            e => getDateStr(e.start) === getDateStr(info.date) &&
                 getHour(e.start) === getHour(info.date)
        ).length;
        return `${info.text}（${count}件）`;
    }
});

calendar.render();
</script>

</body>
</html>
