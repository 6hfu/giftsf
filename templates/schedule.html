<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー</title>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
/* --- 月ビューステータス --- */
.month-summary {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    margin-top: 2px;
}
.summaryBox {
    width: 23%;
    height: 20px;
    line-height: 20px;
    text-align: center;
    border-radius: 4px;
    color: #fff;
    font-weight: bold;
}
.summaryDone { background-color: #4caf50; }     /* 完了 */
.summaryPending { background-color: #ff9800; }  /* 保留 */
.summaryInProgress { background-color: #2196f3; } /* 進行中 */
.summaryCancelled { background-color: #f44336; } /* キャンセル */

/* --- 日・週ビュー枠調整 --- */
.fc-timegrid-slot {
    height: 50px; /* 各時間枠を縦に大きく */
}
.slot-label {
    font-size: 12px;
    margin: 2px 0;
    padding: 2px 4px;
    border-radius: 3px;
    color: #fff;
}
.slot-labelDone { background: #4caf50; }
.slot-labelPending { background: #ff9800; }
.slot-labelInProgress { background: #2196f3; }
.slot-labelCancelled { background: #f44336; }
</style>
</head>
<body>

<div id="calendar"></div>

<script>
// サーバーから渡されるイベント配列
const RAW_EVENTS_ORIG = {{ events | tojson }};

// ----------------- マイナス6時間補正 -----------------
const RAW_EVENTS = RAW_EVENTS_ORIG.map(e => {
    const dt = new Date(e.start);
    dt.setHours(dt.getHours() - 6); // ←6時間補正
    return { ...e, start: dt };
});

// 日付/時間取得
function getDateStr(dt){ return new Date(dt).toISOString().split("T")[0]; }
function getHourStr(dt){ return new Date(dt).toISOString().split("T")[1].split(":")[0]; }

// ----------------- 月ビューサマリ -----------------
function renderMonthSummary(calendar, info){
    if(calendar.view.type !== "dayGridMonth") return;
    const dateStr = info.date.toISOString().split("T")[0];
    const dayEvents = RAW_EVENTS.filter(e => getDateStr(e.start) === dateStr);

    const statuses = ["Done","Pending","InProgress","Cancelled"]; // 4ステータス固定
    const grouped = {};
    statuses.forEach(s => grouped[s] = 0);
    dayEvents.forEach(e => { if(e.status) grouped[e.status] = (grouped[e.status]||0)+1; });

    const wrap = document.createElement("div");
    wrap.className = "month-summary";
    statuses.forEach(s => {
        const div = document.createElement("div");
        div.className = "summaryBox summary"+s;
        div.textContent = s + " " + grouped[s];
        wrap.appendChild(div);
    });

    const target = info.el.querySelector(".fc-daygrid-day-frame") || info.el.querySelector(".fc-daygrid-day-events");
    target?.appendChild(wrap);
}

// ----------------- 日・週ビュー縦5枠 -----------------
function renderDayWeekSlots(info){
    const viewType = info.view.type;
    if(!["timeGridDay","timeGridWeek"].includes(viewType)) return;

    const dateStr = info.date.toISOString().split("T")[0];
    const hour = info.date.getHours();
    const hourEvents = RAW_EVENTS.filter(e => getDateStr(e.start) === dateStr && parseInt(getHourStr(e.start)) === hour);
    if(hourEvents.length === 0) return;

    const maxSlots = 5;
    const displayEvents = hourEvents.slice(0, maxSlots);

    const wrap = document.createElement("div");
    wrap.style.display = "flex";
    wrap.style.flexDirection = "column";
    wrap.style.height = "100%";
    displayEvents.forEach((e,i) => {
        const div = document.createElement("div");
        div.className = "slot-label slot-label"+e.status.replace(/\s/g,"");
        div.textContent = e.status;
        div.style.flex = "1"; // 縦に均等分割
        wrap.appendChild(div);
    });

    // 週ビューは件数表示なし
    if(viewType === "timeGridWeek") wrap.innerHTML = wrap.innerHTML; 

    info.el.appendChild(wrap);
}

// ----------------- カレンダー初期化 -----------------
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"),{
    locale: "ja",
    initialView: "dayGridMonth",
    height: "auto",
    headerToolbar: { left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay" },
    nowIndicator: true,
    slotMinTime: "08:00:00",
    slotMaxTime: "20:00:00",
    allDaySlot: false,

    dayCellDidMount: info => renderMonthSummary(calendar, info),
    slotLaneContent: info => renderDayWeekSlots(info),

    dateClick: info => calendar.changeView("timeGridDay", info.dateStr),

    slotLabelContent: info => {
        const viewType = calendar.view.type;
        if(viewType === "timeGridWeek") return info.text; // 週ビューは件数非表示
        const dateStr = info.date.toISOString().split("T")[0];
        const hour = info.date.getHours();
        const hourEvents = RAW_EVENTS.filter(e => getDateStr(e.start) === dateStr && parseInt(getHourStr(e.start)) === hour);
        return info.text + " (" + hourEvents.length + ")";
    }
});

calendar.render();
</script>

</body>
</html>
