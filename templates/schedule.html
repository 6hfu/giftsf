<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー（週・日）</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    background: #f5f7fa;
    font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
}

/* ===== 土日背景 ===== */
.fc-day-sun { background: rgba(244, 67, 54, 0.06); }
.fc-day-sat { background: rgba(33, 150, 243, 0.06); }

/* ===== 週・日ビュー：時間枠を広げる ===== */
.fc-timegrid-slot {
    height: 48px !important;
}

/* ===== 事件イベントスタイル ===== */
.summary-event {
    font-size: 12px;
    font-weight: bold;
    color: #fff;
    text-align: center;
    line-height: 1.2;
    border-radius: 4px;
}
</style>
</head>

<body>
<div id="calendar"></div>

<script>
// ==========================
// サーバーから取得したイベント
// ==========================
const RAW_EVENTS_ORIG = {{ events | tojson | safe }};

// ===== 時刻補正（-6時間）=====
const RAW_EVENTS = RAW_EVENTS_ORIG.map(e => {
    const d = new Date(e.start);
    d.setHours(d.getHours() - 6);
    return { ...e, start: d };
});

// ステータス色
const STATUS_COLORS = {
    "商談待ち": "#2196F3",
    "返答待ち": "#03A9F4",
    "リスケ": "#FF9800",
    "留守": "#FFC107"
};
const STATUSES = Object.keys(STATUS_COLORS);

// ==========================
// 時間帯ごとの件数集計イベント作成
// ==========================
function generateSummaryEvents() {
    const summaryEvents = [];

    // 08:00〜20:00 までの時間帯
    for (let hour = 8; hour <= 20; hour++) {
        // 日付ごとにまとめる
        const dayMap = {};

        RAW_EVENTS.forEach(ev => {
            const d = new Date(ev.start);
            const dateStr = d.toISOString().split("T")[0];
            if (!dayMap[dateStr]) dayMap[dateStr] = {};
            if (!dayMap[dateStr][hour]) dayMap[dateStr][hour] = {};
            if (!dayMap[dateStr][hour][ev.status]) dayMap[dateStr][hour][ev.status] = 0;
            dayMap[dateStr][hour][ev.status]++;
        });

        // イベント化
        for (const dateStr in dayMap) {
            const counts = dayMap[dateStr][hour];
            if (!counts) continue;

            const total = Object.values(counts).reduce((a,b)=>a+b,0);
            let color = "#2196F3"; // デフォルト

            // 件数が多いと色を濃くする
            if (total >= 5) color = "#0D47A1";
            else if (total >= 3) color = "#1976D2";
            else color = "#42A5F5";

            let text = Object.entries(counts).map(([status,count]) => `${status}:${count}`).join(" ");

            summaryEvents.push({
                title: text,
                start: `${dateStr}T${String(hour).padStart(2,'0')}:00:00`,
                end: `${dateStr}T${String(hour+1).padStart(2,'0')}:00:00`,
                display: 'block',
                backgroundColor: color,
                borderColor: color,
                classNames: ['summary-event'],
            });
        }
    }

    return summaryEvents;
}

// ==========================
// カレンダー初期化
// ==========================
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    locale: "ja",
    initialView: "timeGridWeek",
    height: "auto",

    customButtons: {
        corporateform: {
            text: "商談登録",
            click: function () {
                window.location.href = "https://giftsf.onrender.com/corporateform";
            }
        }
    },

    headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "corporateform timeGridWeek,timeGridDay"
    },

    buttonText: {
        today: "今日",
        week: "週",
        day: "日"
    },

    nowIndicator: true,
    allDaySlot: false,
    slotMinTime: "08:00:00",
    slotMaxTime: "20:00:00",

    events: generateSummaryEvents()
});

calendar.render();
</script>
</body>
</html>
