<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body { font-family: system-ui, -apple-system; background:#f4f6f8; margin:0; padding:16px; }
#calendar { background:#fff; border-radius:12px; padding:12px; }

/* 月ビュー用サマリラベル */
.summary { font-size:14px; padding:6px 8px; border-radius:6px; color:#fff; margin-bottom:3px; display:inline-block; }

/* ステータス別色 */
.summary留守      { background:#FFC107; color:#000; }
.summaryリスケ    { background:#FF9800; color:#fff; }
.summary返答待ち  { background:#03A9F4; color:#fff; }
.summary商談待ち  { background:#2196F3; color:#fff; }

/* ガントチャート風イベント */
.fc-event {
    font-size:14px;
    padding:6px 8px;
    border-radius:6px;
    margin:2px 0;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

/* ステータス別色 */
.fc-event留守      { background:#FFC107; color:#000; }
.fc-eventリスケ    { background:#FF9800; color:#fff; }
.fc-event返答待ち  { background:#03A9F4; color:#fff; }
.fc-event商談待ち  { background:#2196F3; color:#fff; }
.fc-event-default  { background:#BDBDBD; color:#fff; }
</style>
</head>
<body>
<div id="calendar"></div>

<script>
const RAW_EVENTS = {{ events | tojson }};

// 月ビューサマリ
function renderMonthSummary(calendar, info){
    if(calendar.view.type!=="dayGridMonth") return;
    const dateStr = info.date.toISOString().split("T")[0];
    const dayEvents = RAW_EVENTS.filter(e=>e.start.startsWith(dateStr));
    if(dayEvents.length===0) return;

    const grouped = {};
    dayEvents.forEach(e=>{ if(e.status) grouped[e.status]=(grouped[e.status]||0)+1; });

    const wrap = document.createElement("div");
    for(const status of Object.keys(grouped)){
        const div = document.createElement("div");
        div.className = "summary summary"+status.replace(/\s/g,"");
        div.textContent = status+" "+grouped[status]+"件";
        wrap.appendChild(div);
    }

    const target = info.el.querySelector(".fc-daygrid-day-events") || info.el.querySelector(".fc-daygrid-day-frame");
    target?.appendChild(wrap);
}

// FullCalendar用変換（縦5枠対応）
function prepareFCEvents(raw){
    // 日ビュー専用用に枠情報も追加
    const dayMap = {};
    raw.forEach(e=>{
        const dt = new Date(e.start);
        const dateStr = dt.toISOString().split("T")[0];
        const hour = dt.getHours();

        dayMap[dateStr] = dayMap[dateStr] || {};
        dayMap[dateStr][hour] = dayMap[dateStr][hour] || [];
        dayMap[dateStr][hour].push(e);
    });

    // 枠数5固定、超過は最後に+N
    const events = [];
    Object.keys(dayMap).forEach(date=>{
        Object.keys(dayMap[date]).forEach(hour=>{
            const list = dayMap[date][hour];
            const maxSlots = 5;
            const overflow = list.length > maxSlots ? list.length - maxSlots + 1 : 0;

            for(let i=0;i<Math.min(maxSlots,list.length);i++){
                const e = list[i];
                const start = new Date(e.start);
                const end = new Date(start.getTime()+30*60*1000);
                events.push({
                    start:start,
                    end:end,
                    title:i===maxSlots-1 && overflow>0 ? "+"+overflow : e.status,
                    className:"fc-event"+e.status.replace(/\s/g,"")
                });
            }
        });
    });

    return events;
}

const EVENTS = prepareFCEvents(RAW_EVENTS);

// カレンダー初期化
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"),{
    locale:"ja",
    initialView:"dayGridMonth",
    height:"auto",
    headerToolbar:{ left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay" },
    events:EVENTS,
    eventDisplay:"block",
    nowIndicator:true,
    slotMinTime:"08:00:00",
    slotMaxTime:"20:00:00",
    allDaySlot:false,
    dayCellDidMount:function(info){ renderMonthSummary(calendar, info); },
    dateClick:function(info){ calendar.changeView("timeGridDay", info.dateStr); },
    slotLabelContent:function(info){
        // 時間横に件数表示
        const dateStr = calendar.getDate().toISOString().split("T")[0];
        const hourEvents = RAW_EVENTS.filter(e=>{
            const d = new Date(e.start);
            return d.getHours() === info.date.getHours() &&
                   d.toISOString().startsWith(dateStr);
        });
        return info.text+" ("+hourEvents.length+")";
    }
});

calendar.render();
</script>
</body>
</html>
