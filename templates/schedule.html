<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body { font-family: system-ui, -apple-system; background:#f4f6f8; margin:0; padding:16px; }
#calendar { background:#fff; border-radius:12px; padding:12px; }

/* 月ビュー縦ラベル */
.summary { font-size:14px; padding:6px 8px; border-radius:6px; color:#fff; margin-bottom:4px; display:block; }
.summary留守      { background:#FFC107; color:#000; }
.summaryリスケ    { background:#FF9800; color:#fff; }
.summary返答待ち  { background:#03A9F4; color:#fff; }
.summary商談待ち  { background:#2196F3; color:#fff; }

/* 日・週ビュー縦5枠ラベル */
.slot-label { font-size:14px; padding:6px 8px; border-radius:6px; margin:2px 0; text-align:center; color:#fff; }
.slot-label留守      { background:#FFC107; color:#000; }
.slot-labelリスケ    { background:#FF9800; color:#fff; }
.slot-label返答待ち  { background:#03A9F4; color:#fff; }
.slot-label商談待ち  { background:#2196F3; color:#fff; }
</style>
</head>
<body>
<div id="calendar"></div>

<script>
const RAW_EVENTS = {{ events | tojson }};

// 日付文字列だけ取得
function getDateStr(iso){ return iso.split("T")[0]; }
function getHourStr(iso){ return iso.split("T")[1].split(":")[0]; }

// ----------------- 月ビューサマリ -----------------
function renderMonthSummary(calendar, info){
    if(calendar.view.type !== "dayGridMonth") return;

    const dateStr = info.date.toISOString().split("T")[0];
    const dayEvents = RAW_EVENTS.filter(e => getDateStr(e.start) === dateStr);
    if(dayEvents.length===0) return;

    const grouped = {};
    dayEvents.forEach(e => { if(e.status) grouped[e.status] = (grouped[e.status]||0)+1; });

    const wrap = document.createElement("div");
    for(const status of Object.keys(grouped)){
        const div = document.createElement("div");
        div.className = "summary summary"+status.replace(/\s/g,"");
        div.textContent = status + " " + grouped[status] + "件";
        wrap.appendChild(div);
    }

    const target = info.el.querySelector(".fc-daygrid-day-frame") || info.el.querySelector(".fc-daygrid-day-events");
    target?.appendChild(wrap);
}

// ----------------- 日・週ビュー縦5枠 -----------------
function renderDayWeekSlots(info){
    if(!["timeGridDay","timeGridWeek"].includes(info.view.type)) return;

    const dateStr = info.date.toISOString().split("T")[0];
    const hour = info.date.getHours();

    const hourEvents = RAW_EVENTS.filter(e => getDateStr(e.start) === dateStr && parseInt(getHourStr(e.start)) === hour);
    if(hourEvents.length===0) return;

    const maxSlots = 5;
    const overflow = hourEvents.length > maxSlots ? hourEvents.length - maxSlots + 1 : 0;
    const displayEvents = hourEvents.slice(0,maxSlots);

    const wrap = document.createElement("div");
    displayEvents.forEach((e,i)=>{
        const div = document.createElement("div");
        div.className = "slot-label slot-label"+e.status.replace(/\s/g,"");
        div.textContent = (i===maxSlots-1 && overflow>0) ? "+"+overflow : e.status;
        wrap.appendChild(div);
    });

    info.el.appendChild(wrap);
}

// ----------------- カレンダー初期化 -----------------
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"),{
    locale: "ja",
    initialView: "dayGridMonth",
    height: "auto",
    headerToolbar: { left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay" },
    nowIndicator: true,
    slotMinTime: "08:00:00",
    slotMaxTime: "20:00:00",
    allDaySlot: false,

    dayCellDidMount: info=>renderMonthSummary(calendar, info),
    slotLaneContent: info=>renderDayWeekSlots(info),

    dateClick: info=>calendar.changeView("timeGridDay", info.dateStr),

    slotLabelContent: info=>{
        const dateStr = calendar.getDate().toISOString().split("T")[0];
        const hour = info.date.getHours();
        const hourEvents = RAW_EVENTS.filter(e => getDateStr(e.start) === dateStr && parseInt(getHourStr(e.start)) === hour);
        return info.text + " (" + hourEvents.length + ")";
    }
});

calendar.render();
</script>

</body>
</html>
