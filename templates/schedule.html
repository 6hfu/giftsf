<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>商談スケジュール</title>

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        /* --- 月表示日付デザイン --- */
        .fc-daygrid-day-number {
            background-color: #f8f9fa;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .fc-daygrid-day {
            position: relative;
        }

        /* --- バッジ表示 --- */
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.7rem;
            border-radius: 8px;
            color: white;
            margin-right: 2px;
            margin-top: 2px;
        }

        /* --- 日表示カード --- */
        .fc-event {
            border: none;
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 0.85rem;
            color: white;
            margin-bottom: 2px;
        }

        /* --- 週表示カード --- */
        .fc-timegrid-event {
            border-radius: 6px;
            padding: 2px 4px;
            font-size: 0.8rem;
            color: white;
        }

        /* 月・週のクリックでday表示 */
        .fc-daygrid-day:hover {
            cursor: pointer;
            background-color: #e9ecef;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <h3 class="mb-3 text-center">商談スケジュール</h3>
    <div id="calendar"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    // ステータス色
    const statusColors = {
        "成約": "#4CAF50",
        "NG": "#9E9E9E",
        "留守": "#FFC107",
        "リスケ": "#FF9800",
        "返答待ち": "#03A9F4",
        "商談待ち": "#2196F3"
    };

    // カレンダー作成
    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ja',
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        events: {{ events | tojson }},

        // 月ビュー：件数バッジ化
        eventContent: function(arg) {
            if (arg.view.type === 'dayGridMonth') {
                // 同じ日付のイベント件数をまとめる
                const count = arg.event.extendedProps.count || 1;
                const status = arg.event.extendedProps.status || '未定';
                const color = statusColors[status] || '#BDBDBD';
                return { html: `<span class="status-badge" style="background-color:${color}">${count}</span>` };
            } else if (arg.view.type === 'timeGridWeek') {
                // 週ビュー：取引先名＋ステータス
                const status = arg.event.extendedProps.status || '未定';
                const color = statusColors[status] || '#BDBDBD';
                return { html: `<div style="background-color:${color}; padding:2px 4px; border-radius:4px;">${arg.event.title} (${status})</div>` };
            } else if (arg.view.type === 'timeGridDay') {
                // 日ビュー：カード型
                const status = arg.event.extendedProps.status || '未定';
                const color = statusColors[status] || '#BDBDBD';
                return { html: `<div class="fc-event" style="background-color:${color}">${arg.event.title}<br>${status}</div>` };
            }
        },

        // 月・週のクリックで日表示に遷移
        dateClick: function(info) {
            calendar.changeView('timeGridDay', info.dateStr);
        },

        // 同じ時間帯のイベントを色分け（週ビュー用）
        eventDidMount: function(info) {
            if (info.view.type === 'timeGridWeek' || info.view.type === 'timeGridDay') {
                const eventsAtSameTime = calendar.getEvents().filter(ev =>
                    ev.startStr === info.event.startStr && ev !== info.event
                );
                const order = eventsAtSameTime.length; // 0,1,2…
                const colors = ['#2196F3', '#FFC107', '#F44336'];
                if (order < 3) {
                    info.el.style.backgroundColor = colors[order];
                } else {
                    info.el.innerHTML = `+${order + 1}件`;
                    info.el.style.backgroundColor = '#9E9E9E';
                }
            }
        },

        nowIndicator: true,
        dayMaxEventRows: true,
        slotMinTime: "08:00:00",
        slotMaxTime: "20:00:00"
    });

    calendar.render();
});
</script>

</body>
</html>
