<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    background: #f5f7fa;
    font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
}

.fc-day-sun { background: rgba(244,67,54,0.06); }
.fc-day-sat { background: rgba(33,150,243,0.06); }

.fc-daygrid-day-frame { min-height: 140px; }

.total-box {
    margin-top: 8px;
    padding: 10px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    color: #fff;
    text-align: center;
}

.fc-timegrid-slot { height: 48px !important; }
</style>
</head>

<body>
<div id="calendar"></div>

<script>
// ==========================
// サーバーから取得
// ==========================
const RAW_EVENTS_ORIG = {{ events | tojson }};

// -6時間補正
const RAW_EVENTS = RAW_EVENTS_ORIG.map(e => {
    const d = new Date(e.start);
    d.setHours(d.getHours() - 6);
    return { ...e, start: d };
});

const dateStr = d => d.toISOString().split("T")[0];

// ==========================
// ヒートカラー（最大5件）
// ==========================
function heatColor(c){
    if(c === 1) return "#E3F2FD";
    if(c === 2) return "#90CAF9";
    if(c === 3) return "#FFCC80";
    if(c === 4) return "#FF8A65";
    if(c >= 5) return "#E53935";
    return "#eee";
}

// ==========================
// 月：日ごと合計＋最大被り
// ==========================
function renderMonth(info){
    if(info.view.type !== "dayGridMonth") return;

    const events = RAW_EVENTS.filter(e => dateStr(e.start) === dateStr(info.date));
    if(events.length === 0) return;

    const hourMap = {};
    events.forEach(e => {
        const h = e.start.getHours();
        hourMap[h] = (hourMap[h] || 0) + 1;
    });

    const maxOverlap = Math.max(...Object.values(hourMap));

    const box = document.createElement("div");
    box.className = "summary";
    box.style.background = heatColor(maxOverlap);
    box.textContent = `合計 ${events.length}件`;

    info.el.querySelector(".fc-daygrid-day-frame")?.appendChild(box);
}

// ==========================
// ★ 週・日：時間帯イベント生成
// ==========================
function buildTimeEvents(){
    const map = {};

    RAW_EVENTS.forEach(e => {
        const d = new Date(e.start);
        d.setMinutes(0,0,0);

        const key = `${dateStr(d)} ${String(d.getHours()).padStart(2,"0")}:00`;
        map[key] = (map[key] || 0) + 1;
    });

    return Object.entries(map).map(([key, count]) => {
        const [date, hour] = key.split(" ");
        const start = new Date(`${date}T${hour}:00`);
        const end   = new Date(start.getTime() + 60*60000);

        return {
            start,
            end,
            title: `${count}件`,
            backgroundColor: heatColor(count),
            borderColor: heatColor(count),
            textColor: "#000"
        };
    });
}

// ==========================
// カレンダー
// ==========================
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    locale: "ja",
    initialView: "dayGridMonth",
    height: "auto",

    headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
    },

    nowIndicator: true,
    allDaySlot: false,
    slotMinTime: "08:00:00",
    slotMaxTime: "20:00:00",

    dayCellDidMount: renderMonth,

    events: buildTimeEvents(),

    dateClick: info => calendar.changeView("timeGridDay", info.dateStr)
});

calendar.render();
</script>

</body>
</html>
