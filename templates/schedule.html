<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>商談カレンダー（週）</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        body {
            background: #f5f7fa;
            font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", sans-serif;
            margin: 0;
        }

        /* 土日背景 */
        .fc-day-sun { background: rgba(244, 67, 54, 0.06); }
        .fc-day-sat { background: rgba(33, 150, 243, 0.06); }

        /* 1画面に収めるため時間枠を圧縮 */
        .fc-timegrid-slot { height: 34px !important; }

        /* 件数イベントだけ高さを2時間分にする */
        .summary-event {
            font-size: 20px;
            font-weight: 700;
            text-align: left;
            line-height: 1.2;
            border-radius: 8px;
        
            /* 高さを指定（例: 2時間分 = 34px × 2 × 60分 ÷ 1分の高さ?） */
            height: calc(68px * 2 * 60 / 60); /* 2時間分 */
            min-height: calc(68px * 2); /* 安全策としてmin-heightも */
        }


        /* リロード促しバー */
        #reloadNotice {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #1976D2;
            color: #fff;
            padding: 12px 20px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            cursor: pointer;
            display: none;
            z-index: 9999;
        }
        #reloadNotice:hover { background: #0D47A1; }
    </style>
</head>
<body>
    <div id="calendar"></div>
    <div id="reloadNotice">⟳ しばらく更新されていません。クリックして再読み込み</div>

    <script>
    // ==========================
    // サーバーから取得したイベント
    // ==========================
    const RAW_EVENTS = {{ events | tojson | safe }};
    
    // ==========================
    // 件数ごとの色（濃い青 → 赤）
    // ==========================
    function getColorByCount(count) {
        const colors = [
            '#1976D2', // 1件
            '#1565C0', // 2件
            '#0D47A1', // 3件
            '#FBC02D', // 4件
            '#FB8C00', // 5件
            '#F4511E', // 6件
            '#D32F2F', // 7件以上
        ];
        return colors[Math.min(count - 1, colors.length - 1)];
    }
    
    // ==========================
    // 文字色自動判定
    // ==========================
    function getTextColor(bgColor) {
        const rgb = bgColor.match(/\d+/g).map(Number);
        const brightness = (rgb[0]*299 + rgb[1]*587 + rgb[2]*114) / 1000;
        return brightness > 150 ? '#000' : '#fff';
    }

        
    // ==========================
    // 2時間単位で件数集計（+9時間補正）
    // ==========================
    function generateSummaryEvents() {
        const events = [];
    
        // JSTに変換した Date 配列を作る
        const jstDates = RAW_EVENTS
            .filter(ev => ev.start)
            .map(ev => {
                const d = new Date(ev.start);
                d.setHours(d.getHours() + 9);
                return d;
            })
            .sort((a, b) => a - b);
    
        jstDates.forEach(baseDt => {
            const startDt = new Date(baseDt);
            const endDt = new Date(baseDt);
            endDt.setHours(endDt.getHours() + 2);
    
            // 2時間以内に含まれる件数をカウント
            const count = jstDates.filter(d =>
                d >= startDt && d < endDt
            ).length;
    
            if (count === 0) return;
    
            const bg = getColorByCount(count);
    
            const dateStr = startDt.toISOString().split("T")[0];
            const sh = String(startDt.getHours()).padStart(2, '0');
            const sm = String(startDt.getMinutes()).padStart(2, '0');
            const eh = String(endDt.getHours()).padStart(2, '0');
            const em = String(endDt.getMinutes()).padStart(2, '0');
    
            events.push({
                title: `${count}件`,
                start: `${dateStr}T${sh}:${sm}:00`,
                end: `${dateStr}T${eh}:${em}:00`,
                display: 'block',
                backgroundColor: bg,
                borderColor: bg,
                textColor: getTextColor(bg),
                classNames: ['summary-event']
            });
        });
    
        return events;
    }

    
    // ==========================
    // リロード管理
    // ==========================
    const RELOAD_LIMIT_MINUTES = 10;
    const now = Date.now();
    const lastReload = localStorage.getItem("lastReloadTime");
    
    if (lastReload) {
        const diff = (now - Number(lastReload)) / 1000 / 60;
        if (diff >= RELOAD_LIMIT_MINUTES) {
            document.getElementById("reloadNotice").style.display = "block";
        }
    }
    
    document.getElementById("reloadNotice").onclick = () => location.reload();
    localStorage.setItem("lastReloadTime", now);
    
    // ==========================
    // カレンダー初期化
    // ==========================
    const calendar = new FullCalendar.Calendar(
        document.getElementById("calendar"),
        {
            locale: "ja",
            initialView: "timeGridWeek",
            height: "100vh",
    
            customButtons: {
                reload: {
                    text: "再読込",
                    click: () => location.reload()
                },
                corporateform: {
                    text: "商談登録",
                    click: () =>
                        location.href = "https://giftsf.onrender.com/corporateform"
                },
                backmenu: {
                    text: "メニューに戻る",
                    click: () =>
                        location.href = "https://giftsf.onrender.com/menu_page"
                }
            },
    
            headerToolbar: {
                left: "prev,next today reload",
                center: "title",
                right: "backmenu corporateform"
            },
    
            nowIndicator: true,
            allDaySlot: false,
            slotMinTime: "09:00:00",
            slotMaxTime: "20:00:00",
    
            events: generateSummaryEvents()
        }
    );
    
    calendar.render();
    </script>

</body>
</html>
