<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body { font-family: system-ui, -apple-system; background:#f4f6f8; margin:0; padding:16px; }
#calendar { background:#fff; border-radius:12px; padding:12px; }

/* 月ビューサマリ（件数表示は optional） */
.summary { font-size:13px; padding:4px 6px; border-radius:6px; color:#fff; margin-bottom:3px; white-space:nowrap; }

/* ガントチャート風イベント */
.fc-event {
    font-size:14px;           /* 文字大きく */
    padding:4px 6px;          /* パディング広め */
    border-radius:6px;
    margin:2px 0;
    text-align:center;
}

/* ステータス別色 */
.fc-event留守      { background:#FFC107; color:#000; }
.fc-eventリスケ    { background:#FF9800; color:#fff; }
.fc-event返答待ち  { background:#03A9F4; color:#fff; }
.fc-event商談待ち  { background:#2196F3; color:#fff; }
.fc-event-default  { background:#BDBDBD; color:#fff; }
</style>
</head>
<body>
<div id="calendar"></div>

<script>
// Pythonから渡されたevents
const RAW_EVENTS = {{ events | tojson }};

// 月ビューサマリ（件数表示 optional）
function renderMonthSummary(calendar, info){
    if(calendar.view.type!=="dayGridMonth") return;
    const dateStr = info.date.toISOString().split("T")[0];
    const dayEvents = RAW_EVENTS.filter(e=>e.start.startsWith(dateStr) && !["成約","NG"].includes(e.status));
    if(dayEvents.length===0) return;
    const grouped = {};
    dayEvents.forEach(e=>{ if(e.status) grouped[e.status]=(grouped[e.status]||0)+1; });
    const wrap = document.createElement("div");
    for(const status of Object.keys(grouped)){
        const div = document.createElement("div");
        div.className = "summary";
        div.textContent = status; // 件数非表示
        wrap.appendChild(div);
    }
    const target = info.el.querySelector(".fc-daygrid-day-events") || info.el.querySelector(".fc-daygrid-day-frame");
    target?.appendChild(wrap);
}

// FullCalendar用に変換（30分ブロック）
function prepareFCEvents(raw){
    return raw
        .filter(e => !["成約","NG"].includes(e.status)) // 非表示ステータス除外
        .map(e=>{
            const start = new Date(e.start);
            const end = e.end ? new Date(e.end) : new Date(start.getTime()+30*60*1000);
            const cls = e.status ? "fc-event"+e.status.replace(/\s/g,"") : "fc-event-default";
            return { start:start, end:end, title:e.status, className:cls };
        });
}

const EVENTS = prepareFCEvents(RAW_EVENTS);

// カレンダー初期化
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"),{
    locale:"ja",
    initialView:"dayGridMonth",
    height:"auto",
    headerToolbar:{ left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay" },
    events:EVENTS,
    eventDisplay:"block",      // ガントチャート風積み上げ
    nowIndicator:true,
    slotMinTime:"08:00:00",
    slotMaxTime:"20:00:00",
    allDaySlot:false,
    dayCellDidMount: function(info){ renderMonthSummary(calendar, info); },
    dateClick:function(info){ calendar.changeView("timeGridDay", info.dateStr); }
});

calendar.render();
</script>
</body>
</html>
