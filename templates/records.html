<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>登録済みレコード一覧</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <style>
        /* === 全体 === */
        body { background-color: #f8f9fa; }
        .container { max-width: 100%; padding: 2rem 3rem; transition: padding-right 0.3s ease; }

        h2 {
            font-weight: 700; color: #343a40; margin-bottom: 2rem;
            border-bottom: 3px solid #0d6efd; padding-bottom: 0.5rem;
        }

        /* === テーブル === */
        table { font-size: 0.85rem; table-layout: fixed; width: 100%; background-color: #fff; }
        thead th {
            background: linear-gradient(to right, #a6dcff, #eaf7ff);
            font-weight: 600; color: #0d3c61; text-align: center;
        }
        th, td { padding: 0.75rem; vertical-align: middle; border-bottom: 1px solid #e3f3fa; }
        tbody tr:hover { background-color: #f0faff; }

        th:nth-child(1){width:70px;} th:nth-child(2){width:80px;}
        th:nth-child(3){width:70px;} th:nth-child(4){width:90px;}
        th:nth-child(5){width:100px;} th:nth-child(6){width:70px;}
        th:nth-child(7){width:70px;} th:nth-child(10){width:70px;}

        /* === フィルタメニュー === */
        #filter-menu {
            position: fixed; top: 0; right: 0; height: 100vh; width: 280px;
            background: #fff; border-left: 1px solid #dee2e6; padding: 1.25rem 1.5rem;
            overflow-y: auto; transition: all 0.3s ease;
        }
        #filter-menu.closed { width: 0; padding: 0; border: none; overflow: hidden; }
        .container.menu-open { padding-right: 300px; }

        #filter-menu-open-btn, #filter-menu-close-btn {
            position: fixed; top: 1rem; right: 1rem; z-index: 1060;
            padding: 0.4rem 1rem; font-weight: 600; border-radius: 0.375rem;
        }
        #filter-menu-open-btn { background: #0d6efd; color: #fff; display: none; }
        #filter-menu-close-btn { background: #dc3545; color: #fff; }
    </style>
</head>
<body>
    <button id="filter-menu-open-btn">検索MENUを開く</button>
    <button id="filter-menu-close-btn">検索MENUを閉じる</button>

    <div class="container py-5 menu-open">
        <h2>受注案件一覧</h2>

        <!-- ===== フィルタメニュー ===== -->
        <div id="filter-menu">
            <h5>検索・絞り込みメニュー</h5>
            <div class="row">
                <div class="col-md-12">
                    <label for="search-box">キーワード検索</label>
                    <input type="search" id="search-box" class="form-control form-control-sm" placeholder="検索語を入力..." />
                </div>
                <div class="col-md-4 mt-3">
                    <label for="filter-column-2">商材名で絞り込み</label>
                    <select id="filter-column-2" class="form-select form-select-sm">
                        <option value="">すべて</option>
                    </select>
                </div>
                <div class="col-md-4 mt-3">
                    <label for="filter-column-4">前確ステータスで絞り込み</label>
                    <select id="filter-column-4" class="form-select form-select-sm">
                        <option value="">すべて</option>
                    </select>
                </div>
                <div class="col-md-12 mt-3">
                    <label for="date-target">絞り込み対象日付</label>
                    <select id="date-target" class="form-select form-select-sm">
                        <option value="2" selected>受注日時</option>
                        <option value="5">CLOK日</option>
                        <option value="6">申込日</option>
                        <option value="4">次回コール</option>
                    </select>
                </div>
                <div class="col-md-3 mt-3">
                    <label for="min-date">開始日</label>
                    <input type="date" id="min-date" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3 mt-3">
                    <label for="max-date">終了日</label>
                    <input type="date" id="max-date" class="form-control form-control-sm" />
                </div>
                <div class="col-md-4 mt-3">
                    <button id="filter-clear-btn" class="btn btn-secondary w-100">クリア</button>
                </div>
            </div>
        </div>

        <!-- ====== テーブル部分 ====== -->
        <div class="table-responsive mt-4">
            <table id="recordsTable" class="table table-bordered table-striped mb-0">
                <thead>
                    <tr>
                        <th>取引先名</th>
                        <th>商材名</th>
                        <th>受注日時</th>
                        <th>前確ステータス</th>
                        <th>次回コール</th>
                        <th>CLOK日</th>
                        <th>申込日</th>
                        <th>前確備考</th>
                        <th>後確備考</th>
                        <th>操作</th> <!-- ★ 追加 -->
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>{{ record.Name }}</td>
                        <td>{{ record.Field106__c or '' }}</td>
                        <td>{{ record.timetorihiki__c_formatted }}</td>
                        <td>{{ record.Field101__c or '' }}</td>
                        <td>{{ record.Field97__c_formatted }}</td>
                        <td>{{ record.CLOK__c or '' }}</td>
                        <td>{{ record.Field118__c or '' }}</td>
                        <td>{{ (record.Field171__c or '').replace('\n', '<br>') | safe }}</td>
                        <td>{{ (record.Field172__c or '').replace('\n', '<br>') | safe }}</td>
                        <td class="text-center">
                            {% if not record.CLOK__c %}
                                <a href="{{ url_for('edit_record', record_id=record.Id) }}" class="btn btn-sm btn-warning">編集</a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="btn-group mt-4">
            <button class="btn btn-primary" onclick="location.reload();">リロード</button>
            <a href="{{ url_for('menu_page') }}" class="btn btn-secondary">メニューに戻る</a>
        </div>
    </div>

    <!-- ===== JSライブラリ ===== -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
    $(document).ready(function () {
        const table = $('#recordsTable').DataTable({
            paging: true, searching: true, ordering: true, order: [[2, 'desc']],
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json' },
            pageLength: 15, info: true, autoWidth: false,
        });

        $('#search-box').on('input', function () {
            table.search(this.value).draw();
        });

        // 商材・前確ステータスの絞り込み選択肢を動的生成
        function populateSelect(id, colIndex) {
            const select = $(id);
            const unique = new Set();
            table.column(colIndex).data().each(d => { if (d) unique.add(d.trim()); });
            const sorted = Array.from(unique).sort((a,b)=>a.localeCompare(b,'ja'));
            select.html('<option value="">すべて</option>');
            sorted.forEach(v => select.append($('<option>').val(v).text(v)));
        }
        populateSelect('#filter-column-2', 1);
        populateSelect('#filter-column-4', 3);

        $.fn.dataTable.ext.search.push(function (settings, data) {
            const prod = $('#filter-column-2').val();
            const stat = $('#filter-column-4').val();
            if (prod && data[1] !== prod) return false;
            if (stat && data[3] !== stat) return false;

            const idx = parseInt($('#date-target').val());
            const min = $('#min-date').val();
            const max = $('#max-date').val();
            const val = data[idx];
            if (val) {
                const d = new Date(val);
                if (min && d < new Date(min + 'T00:00:00')) return false;
                if (max && d > new Date(max + 'T23:59:59')) return false;
            } else if (min || max) return false;
            return true;
        });

        $('#filter-column-2, #filter-column-4, #date-target, #min-date, #max-date').on('change', ()=>table.draw());

        $('#filter-clear-btn').on('click', function () {
            $('#search-box, #min-date, #max-date').val('');
            $('#filter-column-2, #filter-column-4').val('');
            table.search('').columns().search('').draw();
        });
    });
    </script>
</body>
</html>
