<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商談カレンダー（月）</title>

<!-- FullCalendar CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
    background: #f5f7fa;
    font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
    margin: 0;
    padding: 0;
}

/* ヘッダ右上ボタン */
.fc-header-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* 土日背景 */
.fc-day-sun { background: rgba(244, 67, 54, 0.08); }
.fc-day-sat { background: rgba(33, 150, 243, 0.08); }

/* 月ビューのステータスラベル */
.summary-wrap {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100px;
    margin-top: 6px;
    gap: 6px;
}

.summary {
    font-size: 13px;
    padding: 6px 8px;
    border-radius: 6px;
    color: #fff;
    min-height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    font-weight: 600;
    box-sizing: border-box;
}

/* 月/週/日ボタン */
.view-buttons {
    display: flex;
    gap: 6px;
}

.view-buttons button {
    background: #2196F3;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 4px 10px;
    cursor: pointer;
}

.view-buttons button:hover {
    background: #1976d2;
}
</style>
</head>
<body>

<div class="view-buttons">
    <button onclick="goMonth()">月</button>
    <button onclick="goWeek()">週</button>
    <button onclick="goDay()">日</button>
</div>

<div id="calendar"></div>

<script>
// ===== サーバーからのイベント =====
const RAW_EVENTS = {{ events | tojson }};

// ===== 基準日（Flaskから渡された base_date） =====
const BASE_DATE = "{{ base_date }}"; // YYYY-MM-DD

// ===== 月ビュー用ユーティリティ =====
const getDateStr = d => {
    if(typeof d === "string") d = new Date(d);
    return d.toISOString().split("T")[0];
};

// ===== 月ビューステータス表示 =====
function renderMonthSummary(info){
    if(info.view.type !== "dayGridMonth") return;

    const dateStr = getDateStr(info.date);

    const STATUSES = ["商談待ち","返答待ち","リスケ","留守"];
    const countMap = {};
    STATUSES.forEach(s => countMap[s] = 0);

    RAW_EVENTS.forEach(e => {
        if(getDateStr(e.start) === dateStr && countMap[e.status] !== undefined){
            countMap[e.status]++;
        }
    });

    const wrap = document.createElement("div");
    wrap.className = "summary-wrap";

    const STATUS_COLORS = {
        "商談待ち": "#2196F3",
        "返答待ち": "#03A9F4",
        "リスケ": "#FF9800",
        "留守": "#FFC107"
    };

    STATUSES.forEach(status => {
        const div = document.createElement("div");
        div.className = "summary";
        if(countMap[status] > 0){
            div.textContent = `${status} ${countMap[status]}件`;
            div.style.backgroundColor = STATUS_COLORS[status];
        }
        wrap.appendChild(div);
    });

    info.el.querySelector(".fc-daygrid-day-frame")?.appendChild(wrap);
}

// ===== カレンダー初期化 =====
const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    locale: "ja",
    initialView: "dayGridMonth",
    initialDate: BASE_DATE,
    height: "auto",

    headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: ""
    },

    buttonText: {
        today: "今日",
        month: "月"
    },

    dayCellDidMount: renderMonthSummary,

    // 日付クリック → 週ページに遷移
    dateClick: info => {
        const dateStr = info.dateStr;
        window.location.href = `/schedule/week?date=${dateStr}`;
    }
});

// 月カレンダー描画
calendar.render();

// ===== 月/週/日ボタン =====
function goMonth(){
    // 現在の基準日で月ページ
    window.location.href = `/schedule/month?date=${BASE_DATE}`;
}
function goWeek(){
    window.location.href = `/schedule/week?date=${BASE_DATE}`;
}
function goDay(){
    window.location.href = `/schedule/day?date=${BASE_DATE}`;
}
</script>

</body>
</html>
